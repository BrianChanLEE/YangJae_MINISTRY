<?
// 데이터베이스 연결과 필요한 함수들을 포함합니다.
include "../include/db_connect.php";
include "../include/function.php";

// 세션 유효성을 검사합니다.
session_check();

// 요청된 구역 인덱스, 서비스 인덱스, 날짜를 받아옵니다.
$req_map_sub_idx=$_REQUEST["map_sub_idx"];
$req_service_idx=$_REQUEST["service_idx"];
$req_month_date=$_REQUEST["month_date"];

// 서비스 인덱스가 숫자인지 확인합니다. 숫자가 아닐 경우 홈으로 리다이렉트합니다.
if (!is_numeric($req_service_idx)){
	echo "<script type='text/javascript'>location.href='/home/';</script>";
	exit;
}

// 날짜 형식이 올바른지 확인합니다. 올바르지 않으면 홈으로 리다이렉트합니다.
if (!chkdate($req_month_date)){
	echo "<script type='text/javascript'>location.href='/home/';</script>";
	exit;	
}

// 구역 인덱스가 빈 값이거나 null인지 확인하고, 그렇다면 홈으로 리다이렉트합니다.
if ($req_map_sub_idx=="" || $req_map_sub_idx==null){
	echo "<script type='text/javascript'>location.href='/home/';</script>";
	exit;
}

// 구역 인덱스가 숫자인지 확인합니다. 숫자가 아니면 홈으로 리다이렉트합니다.
if (!is_numeric($req_map_sub_idx)){
	echo "<script type='text/javascript'>location.href='/home/';</script>";
	exit;
}

// 올바른 구역 인덱스 값인지 확인하기 위해 DB에서 조회합니다.
$sql="select * from ministry_list where map_sub_idx='$req_map_sub_idx'";
$result_type=mysql_query($sql);

// 조회 결과가 없을 경우 홈으로 리다이렉트합니다.
if (!$result_type){
	echo "<script type='text/javascript'>location.href='/home/?e=result_type&service_idx=".$req_service_idx."&month_date=".$req_month_date."';</script>";
}

// 조회된 행의 수를 확인합니다.
$num_rows = mysql_num_rows($result_type);

// 조회된 행이 없을 경우 홈으로 리다이렉트합니다.
if ($num_rows==0){
	echo "<script type='text/javascript'>location.href='/home/?e=num_rows&service_idx=".$req_service_idx."&month_date=".$req_month_date."';</script>";
}

// 조회된 데이터를 배열로 가져옵니다.
$rs=mysql_fetch_array($result_type);
$map_sub_idx = $rs[map_sub_idx];
$ministry_date = $rs[ministry_date];
$ministry_start_date = $rs[ministry_start_date];
$ministry_member_idx = $rs[ministry_member_idx];
$c_map_list_house_idx = $rs["map_list_house_idx"]; // 조건: 가구형태
$c_map_list_visit = $rs["map_list_visit"]; // 조건: 부재자
$c_map_list_enter = $rs["map_list_enter"]; // 조건: 방문거절, 방문금지

// 요청된 구역 인덱스와 조회된 구역 인덱스가 다를 경우 오류 메시지를 출력하고 홈으로 리다이렉트합니다.
if ($map_sub_idx != $req_map_sub_idx){
	echo "<script>
		alert('sub idx value error!!');
		location.href='/home/';
		</script>";
	exit;		
}

// 요청된 날짜와 조회된 날짜가 다를 경우 오류 메시지를 출력하고 홈으로 리다이렉트합니다.
if ($ministry_date != $req_month_date){
	echo "<script>
		alert('date value error!!');
		location.href='/home/';
		</script>";
	exit;
}

// 현재 사용자가 해당 봉사에 참여 중인지 확인합니다.
$m_idx=$_SESSION['m_idx'];
$arr_m_m_cnt=0;
if ($ministry_member_idx != "" && $ministry_member_idx != null){
	$arr_m_m_idx=explode(",",$ministry_member_idx);
	$arr_m_m_cnt=count($arr_m_m_idx);
}else{
	echo "<script>
		alert('error!!');
		location.href='/home/';
		</script>";
	exit;
}

// 참여 중인지 여부를 확인합니다.
$is_member=false;
for ($i=0;$i<$arr_m_m_cnt;$i++){
	if ($arr_m_m_idx[$i]==$m_idx){
		$is_member=true;
		break;
	}
}

// 참여 중이지 않다면 오류 메시지를 출력하고 홈으로 리다이렉트합니다.
if (!$is_member){
	echo "<script>
		alert('error!!');
		location.href='/home/';
		</script>";
	exit;
}

// 봉사가 시작되지 않은 경우 시작일자를 등록합니다.
if ($ministry_start_date == "" || $ministry_start_date == null){
	$ministry_start_date_isnull="Y";
}else{
	$ministry_start_date_isnull="N";
}
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ko" xml:lang="ko">
<head>
<?include "../include/head.html";?>
</head>
<body> 

    <div class="page-home">
      <div class="container">	  

		<?
// 선택된 구역의 정보를 DB에서 가져옵니다.
$sql="SELECT * FROM map_normal_sub WHERE map_sub_idx='$req_map_sub_idx'";
$result_type=mysql_query($sql);
$rs=mysql_fetch_array($result_type);
$map_sub_no=strip_tags($rs[map_sub_no]);
$map_sub_info=strip_tags($rs[map_sub_info]);
$map_sub_cnt=$rs[map_sub_cnt];
$map_sub_addr=$rs[map_sub_addr];
$map_sub_polygon=$rs[map_sub_polygon];
$bbb="";

// 다각형 좌표가 있으면 이를 설정합니다.
if ($map_sub_polygon!=""){
$chars = explode ("),(", $map_sub_polygon);

for ($i=0;$i<count($chars);$i++)
{
  if ($i == 0){
	$sss.="new daum.maps.LatLng".$chars[$i]."),";

  }else{
	  if ($i==count($chars)-1){
		$sss.= "new daum.maps.LatLng(".$chars[$i];
	  }else{
		$sss.= "new daum.maps.LatLng(".$chars[$i]."),";
	  }
  }
  
}

$bbb = $sss;
}

?>
		<div class="row panel panel-success">
		  <div class="panel-heading"><strong>구역번호 : <?=$map_sub_no ?></strong><br>
		    구역명 : <?=$map_sub_info ?><br>
			주소 : <?=$map_sub_addr ?>
		  </div>
		  <div class="panel-body">
			  봉사에 참여하지 않을 경우는 <strong>'나가기'</strong> 버튼을 눌러주세요.<br>
			  봉사를 마친 후에는 <strong>'저장'</strong> 버튼을 눌러주세요.

			 <div class="pull-right">
			 <button type="button" class="btn btn-default btn-sm hidden" onclick="map_view('<?=$map_sub_no ?>', '<?=$req_map_sub_idx ?>', '<?=$map_sub_info ?>', '<?=$map_sub_addr ?>')"><span class="glyphicon glyphicon-map-marker"></span> 지도보기</button>
			 <button type="button" class="btn btn-default btn-sm " onclick="map_list_record('<?=$req_map_sub_idx ?>')"><span class="glyphicon glyphicon-map-marker"></span> 봉사이력보기</button>
			 </div>
			 
		  </div>
		</div>
		
		<?// 사이트 옵션에 따라 지도를 표시할지 여부를 결정합니다.
		if (site_option("ministry_list_map_show")){?>
		<div id="demo" class="collapse in">
		<div id="map" style="width:100%;height:300px;"></div>
		</div>
		<button id="btn-map" class="btn btn-info btn-block text-center hidden" data-toggle="collapse" data-target="#demo">지도닫기</button>
		<br>
		<?}?>

<?
// 추출된 내용이 있는 경우 이를 표시합니다.
if ($c_map_list_house_idx!="" || $c_map_list_visit!="" || $c_map_list_enter!=""){
?>
<div class="row fontsize12 paddingbottom15 paddingleft10">
<strong>추출 내용 :</strong> 
<?
$sql="select * from db_house_type where house_idx in ($c_map_list_house_idx)";
$result=mysql_query($sql);
while($rs2=mysql_fetch_array($result)){
	$house_type=$rs2[house_type];
?>
			<span class="label label-warning"><?=$house_type ?></span> 
<?
}

if ($c_map_list_visit=="N"){
?>
			<span class="label label-warning">부재자</span> 
			<span class="label label-warning">남은집</span> 
<?
}

if ($c_map_list_enter=="Y"){
?>
			<span class="label label-warning">방문거절</span> 
<?
}else if ($c_map_list_enter=="N"){
?>
			<span class="label label-warning">방문금지</span> 
<?
}
?>
</div>
<?
}
?>

		<div class="row marginbottom10">
			<div id="map_normal_list"></div>
		</div>

      </div>

	  <div class="text-center home-btn-bottom">
	    <button type="button" class="btn btn-warning pull-left" style="width:49.5%;" onclick="ministry_out('<?=$req_map_sub_idx ?>')"><span class="glyphicon glyphicon-log-out"></span> 나가기</button>
	    <button type="button" class="btn btn-success " style="width:50%;" onclick="ministry_complete()"><span class="glyphicon glyphicon-saved"></span> 저장 후 나가기</button>
	  </div>

    </div>

<?include "../include/footer.html";?>

</body>
</html>
<script src="/bootstrap/js/bootstrap.min.js"></script>
<script>

// 필요한 변수를 초기화합니다.
	var map_sub_idx="<?=$req_map_sub_idx ?>";
	var service_idx="<?=$service_idx ?>";
	var ministry_recycle_second="<?=MINISTRY_RECYCLE_SECOND ?>";

// map_sub_idx 값이 있는지 확인합니다. 없으면 홈으로 리다이렉트합니다.
	if (map_sub_idx!="") {
		if (service_idx!=2){
			map_list(map_sub_idx);
			setInterval(function(){ map_list(map_sub_idx); }, ministry_recycle_second);
		}

	}else{
		location.href="/home/";
	}

// 가구 리스트를 불러오는 함수입니다.
	function map_list(map_sub_idx){

		$.ajax({
			type: "post",
			url: "ministry_work.php",
			data: "work=ministry_list&map_sub_idx="+map_sub_idx,
			beforeSend: function() {
				var h=($(window).height()/2)+$(window).scrollTop();
				var hh=(h-64);
								
				var w=$(document).width();
				var ww=(w-64)/2;				
				
				$('#load').remove();
				$('body').append('<span id="load">LOADING...</span>');
				$("#load").css("top",hh);
				$("#load").css("left",ww);
				$('#load').fadeIn('normal');
			},
			success: function (msg) {
				
				if (msg=="member_session_error" ||
					msg=="member_empty_error" ||
					msg=="member_include_error"){

					location.href="/home/";
					return;

				}else{

					$("#map_normal_list").html(msg);

					if (service_idx==5){
						$(".road").css("display","none");
						$(".road-no").css("display","none");
					}
				}
			}
		}).done(function( data ) {
			$('#load').fadeOut('normal');
		});	

	}

// 지도를 표시하는 함수입니다.
	function map_view(map_sub_no, map_sub_idx, map_sub_info, map_sub_addr){

		var h=$(window).height()-150;

		$("#map_iframe").attr("height",h);

		var map_url="map_view.html?map_sub_idx="+map_sub_idx+"&map_sub_info="+map_sub_info+"&map_sub_addr="+map_sub_addr+"&h="+h;
			
		$("#modal-title").html("<strong>"+map_sub_no+". "+map_sub_info+"</strong><br><strong>주소</strong>: "+map_sub_addr);
		$("#map_iframe").attr("src",map_url);
        $("#myModalMap").modal();

	}

// 가구 정보를 수정하는 함수입니다.
	function map_info_edit(){

		var map_list_idx = $("#map_list_idx").val();


		var map_list_road = $("#map_list_road").val();
		var map_list_road_no = $("#map_list_road_no").val();
		var map_list_floor = $("#map_list_floor").val();
		var map_list_info = $("#map_list_info").val();
		var map_list_house_idx = $("#house_idx").val();

		$.ajax({
			type: "post",
			url: "ministry_work.php",
			data: "work=map_info_edit&map_list_idx=" + map_list_idx + "&map_list_road=" + map_list_road + "&map_list_road_no=" + map_list_road_no + "&map_list_floor=" + map_list_floor + "&map_list_info=" + map_list_info + "&map_list_house_idx=" + map_list_house_idx,
			success: function (msg) {	
				map_list(map_sub_idx);
			}
		});
		

	}

// 봉사 기록을 삭제하는 함수입니다.
	function map_info_view_del(map_content_idx){

		$.ajax({
			type: "post",
			url: "ministry_work.php",
			data: "work=map_info_view_del&map_content_idx=" + map_content_idx,
			success: function (msg) {
				if (msg=="ok"){
					$("#map_content_idx_"+map_content_idx).remove();
					map_list(map_sub_idx);
				}
			}
		});		
	}

// 봉사 기록을 보기 위한 함수입니다.
	function map_info_view(map_list_idx, map_list_road, map_list_road_no, map_list_floor, map_list_info, map_list_house_idx){

		map_info = map_list_road+" "+map_list_road_no+" "+map_list_floor+" "+map_list_info;

		$.ajax({
			type: "post",
			url: "ministry_work.php",
			data: "work=map_info_view&map_list_idx=" + map_list_idx,
			success: function (msg) {
				$("#map_list_idx").val(map_list_idx);
				$("#map_content_list").html(msg);
			}
		});

		$("#map_list_road").val(map_list_road);
		$("#map_list_road_no").val(map_list_road_no);
		$("#map_list_floor").val(map_list_floor);
		$("#map_list_info").val(map_list_info);
		$("#house_idx").val(map_list_house_idx);
		$("#modal-title2").html("<strong>"+map_info+"</strong>");
        $("#myModalInfo").modal();

	}

// 봉사 기록을 저장하는 함수입니다.
	function map_info_save() {

		var map_list_idx = $("#map_list_idx").val();
		var map_content_content = $("#map_content_content").val();

		$.ajax({
			type: "post",
			url: "ministry_work.php",
			data: "work=map_info_save&map_list_idx=" + map_list_idx + "&map_content_content=" + map_content_content,
			success: function (msg) {	
				$("#map_content_content").val("");
				map_list(map_sub_idx);
			}
		});
	}

// 방문 항목을 체크하는 함수입니다.
	function map_list_visit_Y(map_sub_idx, map_list_idx){

		var visit_Y=$("#map_list_visit_Y_"+map_list_idx);
		var visit_N=$("#map_list_visit_N_"+map_list_idx);

		visit_N.prop("checked",false);

		var set_visit="";

		if (visit_Y.prop("checked")==true){
			set_visit="Y";
		}else{
			set_visit="";
		}

		map_list_update(map_sub_idx, map_list_idx, "map_list_visit", set_visit);
	}

// 부재자 항목을 체크하는 함수입니다.
	function map_list_visit_N(map_sub_idx, map_list_idx){

		var visit_Y=$("#map_list_visit_Y_"+map_list_idx);
		var visit_N=$("#map_list_visit_N_"+map_list_idx);

		visit_Y.prop("checked",false);

		var set_visit="";

		if (visit_N.prop("checked")==true){
			set_visit="N";
		}else{
			set_visit="";
		}

		map_list_update(map_sub_idx, map_list_idx, "map_list_visit", set_visit);
	}

// 방문 거절 항목을 체크하는 함수입니다.
	function map_list_enter_Y(map_sub_idx, map_list_idx){

		var visit_Y=$("#map_list_visit_Y_"+map_list_idx);
		var enter_Y=$("#map_list_enter_Y_"+map_list_idx);
		var enter_N=$("#map_list_enter_N_"+map_list_idx);

		if (enter_Y.prop("checked")==true && !confirm("정말로 '방문거절'인가요?"))
		{
			enter_Y.prop("checked",false);
			return;

		}else{
			
			if (enter_Y.prop("checked")==true){
				visit_Y.prop("checked",true);
			}else{
				visit_Y.prop("checked",false);
			}
			map_list_visit_Y(map_sub_idx, map_list_idx);
		}

		enter_N.prop("checked",false);

		var set_enter="";

		if (enter_Y.prop("checked")==true){
			set_enter="Y";
		}else{
			set_enter="";
		}

		map_list_update(map_sub_idx, map_list_idx, "map_list_enter", set_enter);
	}

// 방문 금지 항목을 체크하는 함수입니다.
	function map_list_enter_N(map_sub_idx, map_list_idx){

		var enter_Y=$("#map_list_enter_Y_"+map_list_idx);
		var enter_N=$("#map_list_enter_N_"+map_list_idx);

		enter_Y.prop("checked",false);

		var set_enter="";

		if (enter_N.prop("checked")==true){
			set_enter="N";
		}else{
			set_enter="";
		}

		map_list_update(map_sub_idx, map_list_idx, "map_list_enter", set_enter);
	}

// 봉사 기록을 업데이트하는 함수입니다.
	function map_list_update(map_sub_idx, map_list_idx, field, val){

		var ministry_start_date_isnull="<?=$ministry_start_date_isnull ?>";
		var month_date="<?=$req_month_date ?>";

		$.ajax({
			type: "post",
			url: "ministry_work.php",
			data: "work=map_list_update&ministry_start_date_isnull="+ministry_start_date_isnull+"&map_sub_idx="+map_sub_idx+"&map_list_idx="+map_list_idx+"&field="+field+"&val="+val+"&month_date="+month_date,
			success: function (msg) {
				if (msg=="member_session_error" ||
					msg=="member_empty_error" ||
					msg=="member_include_error"){

					location.href="/home/";
					return;
				}
			}
		});	

	}

// 저장 버튼을 눌렀을 때 실행되는 함수입니다.
	function ministry_complete(){

		var service_idx="<?=$req_service_idx ?>";
		var month_date="<?=$req_month_date ?>";
		var work="ministry_complete";

		if (service_idx=="2")
		{
			work="ministry_out";
		}

		$.ajax({
			type: "post",
			url: "ministry_work.php",
			data: "work="+work+"&map_sub_idx="+map_sub_idx,
			success: function (msg) {
				if (msg!="")
				{
					alert(msg);
				}
				location.href="/home/?service_idx="+service_idx+"&month_date="+month_date;
			}
		});			

	}

// 나가기 버튼을 눌렀을 때 실행되는 함수입니다.
	function ministry_out(){

		if (!confirm("나가시겠습니까?")){
			return;
		}

		var service_idx="<?=$req_service_idx ?>";
		var month_date="<?=$req_month_date ?>";

		$.ajax({
			type: "post",
			url: "ministry_work.php",
			data: "work=ministry_out&map_sub_idx="+map_sub_idx,
			success: function (msg) {
				location.href="/home/?service_idx="+service_idx+"&month_date="+month_date;
			}
		});			

	}

// 봉사 이력을 보기 위한 함수입니다.
	function map_list_record(map_sub_idx){

		$("#ministry_list_record_detail").html("");

		$.ajax({
			type: "post",
			url: "ministry_work.php",
			data: "work=map_list_record&map_sub_idx="+map_sub_idx,
			success: function (msg) {
				$("#ministry_list_record").html(msg);
				map_list_record_detail(map_sub_idx);
			}
		});		

        $("#myModalRecord").modal();
	}

// 봉사 이력의 세부 내용을 보기 위한 함수입니다.
	function map_list_record_detail(map_sub_idx){

		$("#map_list_date").change(function (){
			
			$("#ministry_list_record_detail").html("");


			var h=$(window).height()-200;

			$("#ministry_list_record_detail").css("height",h);

			var map_list_date=$("#map_list_date").val();

			if (map_list_date==""){
				return;
			}

			$.ajax({
				type: "post",
				url: "ministry_work.php",
				data: "work=map_list_record_detail&map_sub_idx="+map_sub_idx+"&map_list_date="+map_list_date,
				success: function (msg) {
					$("#ministry_list_record_detail").html(msg);

					if (service_idx==5){
						$(".road").css("display","none");
						$(".road-no").css("display","none");
					}
				}
			});				
			
		});

	}

</script>


<!-- 모달 창 -->
<div class="modal" id="myModalMap" role="dialog">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">&times;</button>
				<h4 class="modal-title" id="modal-title">지도</h4>
			</div>
			<div class="modal-body">
				<iframe id="map_iframe" src="" width="100%" height="500"></iframe>
			</div>
		</div>
	</div>
</div>

<!-- 가구 정보 수정 모달 -->
<div class="modal fade" id="myModalInfo" role="dialog">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">&times;</button>
				<h4 class="modal-title" id="modal-title2">정보</h4>

				<div class="form-group row">
					<div class="text-left col-sm-9 col-xs-8">
						<input type="text" id="map_list_road" class="form-control" placeholder="길이름">
						<input type="text" id="map_list_road_no" class="form-control" placeholder="지번">
						<input type="text" id="map_list_floor" class="form-control" placeholder="층">
						<input type="text" id="map_list_info" class="form-control" placeholder="이름/호">
						<select id="house_idx" class="form-control">
							<?
							$sql="select house_idx, house_type from db_house_type";
							$result_type=mysql_query($sql);
							while($rs=mysql_fetch_array($result_type)){
								$house_idx=$rs[house_idx];
								$house_type=$rs[house_type];
								echo "<option value='".$house_idx."'>".$house_type."</option>";
							}
							?>
						</select>
					</div>
					<div class="text-right col-sm-3 col-xs-4">
						<button type="button" class="btn btn-success btn-sm" data-dismiss="modal" onclick="map_info_edit();"><span class="glyphicon glyphicon-edit"></span> 수정</button>	
					</div>
				</div>
			</div>
			<div class="modal-body">
				<form role="form">
					<strong>봉사기록</strong> - 봉사를 하면서 있었던 특이사항을 기록하세요.
					<div class="form-group">
						<input type="hidden" name="map_list_idx" id="map_list_idx">
						<textarea id="map_content_content" rows="4" cols="" class="form-control"></textarea>
					</div>
				</form>	
				<div class="text-right">
					<button type="button" class="btn btn-success btn-sm " data-dismiss="modal" onclick="map_info_save();"><span class="glyphicon glyphicon-ok"></span> 저장</button>	
				</div>

				<div class="">
					<div id="map_content_list" style="height:100px;overflow-y:auto;"></div>
				</div>
				
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default btn-sm" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span> 닫기</button>
			</div>
		</div>
	</div>
</div>

<!-- 봉사 이력 보기 모달 -->
<div class="modal fade" id="myModalRecord" role="dialog">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal">&times;</button>
				<h4 class="modal-title" id="modal-title3">봉사이력보기</h4>
			</div>
			<div class="modal-body">
				<div>이 구역의 이전 봉사 이력을 확인할 수 있습니다.</div>
				<div id="ministry_list_record"></div>
				<div id="ministry_list_record_detail" style="height:300px;overflow-y:auto;"></div>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=<?=DAUM_MAP_API ?>&libraries=services"></script>
<script>
// 지도 초기 설정
var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
    mapOption = {
        center: new daum.maps.LatLng(37.000922, 127.195686), // 지도의 중심좌표
        level: 5 // 지도의 확대 레벨
    };  

// 지도를 생성합니다    
var map = new daum.maps.Map(mapContainer, mapOption); 

// 주소-좌표 변환 객체를 생성합니다
var geocoder = new daum.maps.services.Geocoder();

// 마커 이미지의 이미지 주소입니다
var imageSrc = "http://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png"; 

// 일반 지도와 스카이뷰로 지도 타입을 전환할 수 있는 지도타입 컨트롤을 생성합니다
var mapTypeControl = new daum.maps.MapTypeControl();

// 지도에 컨트롤을 추가해야 지도위에 표시됩니다
map.addControl(mapTypeControl, daum.maps.ControlPosition.TOPRIGHT);

// 지도 확대 축소를 제어할 수 있는  줌 컨트롤을 생성합니다
var zoomControl = new daum.maps.ZoomControl();
map.addControl(zoomControl, daum.maps.ControlPosition.RIGHT);

// 마커 설정 함수
function set_marker(num, addr, info){

	geocoder.addressSearch(addr, function(result, status) {

		// 정상적으로 검색이 완료됐으면 
		 if (status === daum.maps.services.Status.OK) {

			var coords = new daum.maps.LatLng(result[0].y, result[0].x);

			// 마커 이미지의 이미지 크기 입니다
			var imageSize = new daum.maps.Size(24, 35); 
			
			// 마커 이미지를 생성합니다    
			var markerImage = new daum.maps.MarkerImage(imageSrc, imageSize); 

			// 결과값으로 받은 위치를 마커로 표시합니다
			var marker = new daum.maps.Marker({
				map: map,
				position: coords,
				title: info,
				image : markerImage, // 마커 이미지 
				clickable: true // 마커를 클릭했을 때 지도의 클릭 이벤트가 발생하지 않도록 설정합니다
			});


			// 마커에 클릭이벤트를 등록합니다
			daum.maps.event.addListener(marker, 'click', function() {
				  // 마커 위에 인포윈도우를 표시합니다
				  infowindow.open(map, marker);  
			});

			iwRemoveable = true; // removeable 속성을 ture 로 설정하면 인포윈도우를 닫을 수 있는 x버튼이 표시됩니다

			// 인포윈도우로 장소에 대한 설명을 표시합니다
			var infowindow = new daum.maps.InfoWindow({
				content: '<div style="width:150px;text-align:center;padding:15px 7px;font-size:14px;">'+info+'</div>',
				removable : iwRemoveable
			});

			// 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
			if (num==1) {
				map.setCenter(coords);
			}
		} 
	});    

}

<?
	// 구역 내 각 가구에 대해 마커를 설정합니다.
	$sql2="select *	from map_normal_list a where map_sub_idx='$req_map_sub_idx' ";
	$result2=mysql_query($sql2);

	$map_num=1;

	while($rs2=mysql_fetch_array($result2)){
		
		$map_sub_idx=$rs2[map_sub_idx];
		$map_list_idx=$rs2[map_list_idx];
		$map_list_line=$rs2[map_list_line];
		$map_list_road=$rs2[map_list_road];
		$map_list_road_no=$rs2[map_list_road_no];
		$map_list_floor=$rs2[map_list_floor];
		$map_list_info=$rs2[map_list_info];

		$map_addr=$map_list_road." ".$map_list_road_no;

		echo "set_marker('$map_num', '$map_addr','$map_addr $map_list_info');\r\n";

		$map_num++;
	}
?>

// 지도에 다각형을 표시합니다.
var polygon = new daum.maps.Polygon({
	map : map, // 다각형을 표시할 지도 객체
	path:[<?=$bbb ?>],
	fillColor: '#FF0000', // 채움 색
	fillOpacity: 0.3, // 채움 불투명도
	strokeWeight: 2, // 선의 두께 
	strokeColor: '#FF0000', // 선 색
	strokeOpacity: 0.9, // 선 투명도
	strokeStyle: 'solid' // 선 스타일
});

// 지도보기/닫기 버튼의 텍스트를 업데이트합니다.
$("#btn-map").click(function (){
	var btn_text = ($(".collapse").hasClass("in")==true)?"지도보기":"지도닫기";
	$("#btn-map").text(btn_text);
});
</script>