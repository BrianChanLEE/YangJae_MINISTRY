<?php
// 데이터베이스 연결 및 필수 함수 포함
include "../include/db_connect.php";
include "../include/function.php";

// 세션 확인 (사용자가 로그인했는지 확인)
session_check();

// 요청된 날짜와 서비스 인덱스를 변수에 저장
$req_month_date = $_REQUEST["month_date"];
$req_service_idx = $_REQUEST["service_idx"];

// 봉사형태값이 올바른지 확인 (숫자만 가능하도록)
if ($req_service_idx != "") {
    if (!is_numeric($req_service_idx)) {
        // 봉사형태값이 숫자가 아닐 경우, 홈 페이지로 리다이렉트
        echo "<script type='text/javascript'>location.href='/home/';</script>";
        exit;
    }
}

// 날짜가 유효하지 않거나 음수일 경우, 오늘 날짜로 설정
if (!$req_month_date || $req_month_date < 0) {
    $req_month_date = date("Y-m-d");  // 오늘 날짜로 설정
}

// 날짜 형식이 올바른지 확인 (잘못된 날짜일 경우, 홈 페이지로 리다이렉트)
if (!chkdate($req_month_date)) {
    echo "<script type='text/javascript'>location.href='/home/';</script>";
    exit;
}

// 요일 배열을 정의 (일요일부터 시작)
$yoil = array("7", "1", "2", "3", "4", "5", "6");

// 요청된 날짜의 요일을 계산하여 $week_yoil 변수에 저장
$week_yoil = $yoil[date('w', strtotime($req_month_date))];

// 관리자 권한을 가진 사용자인지 확인 (1, 2, 3번 권한 확인)
if (mgr_check("1,2,3")) {

    // 오늘 날짜를 $today 변수에 저장
    $today = date("Y-m-d");

    // 어제 날짜를 $yesterday 변수에 저장
    $yy = date("Y", time());
    $mm = date("m", time());
    $dd = date("d", time()) - 1;
    $yesterday = date("Y-m-d", mktime(0, 0, 0, $mm, $dd, $yy));

    // 같은 날에 중복 작업을 방지하기 위해 작업 리스트를 확인
    $sql = "SELECT * FROM work_list WHERE work_date='$today'";
    $result = mysql_query($sql);
    $num = mysql_num_rows($result);

    // 작업 리스트에 오늘 날짜가 없다면 작업 수행
    if ($num == 0) {

        // 30일 이전의 작업 내역 삭제
        $sql = "DELETE FROM work_list WHERE work_date < date_add(now(), interval -30 day)";
        $result = mysql_query($sql);

        // 현재 작업을 기록 (작업한 날짜와 시간, 작업한 사람을 기록)
        $m_name = $_SESSION['m_name'];
        $sql = "INSERT INTO work_list(work_date, work_datetime, work_member) VALUES ('$today', now(), '$m_name')";
        $result = mysql_query($sql);

        // A 작업: 30일 이전의 로그인 기록 삭제
        $sql = "DELETE FROM member_login_log WHERE login_date < date_add(now(), interval -30 day)";
        $result = mysql_query($sql);

        // B 작업: 하루가 지난 전도인들을 삭제
        $sql = "UPDATE ministry_list SET ministry_member_idx='' WHERE ministry_date < '$today'";
        $result = mysql_query($sql);

        // C 작업: 하루가 지난 후 완료된 구역에 대해 봉사 항목들을 실제 저장 필드로 복사
        $sql = "UPDATE map_normal_list SET 
                    map_list_visit=map_list_visit_c, 
                    map_list_enter=map_list_enter_c 
                WHERE map_sub_idx IN (
                    SELECT map_sub_idx FROM ministry_list 
                    WHERE ministry_date < '$today' 
                    AND ministry_start_date IS NOT NULL 
                    AND ministry_end_date IS NULL
                    AND ministry_ing_cnt=0
                )";
        $result = mysql_query($sql);

        // 완료된 구역에 대해 종료일자를 기록 (남은 구역이 없을 경우)
        $sql = "UPDATE ministry_list SET 
                    ministry_end_date='$yesterday'
                WHERE ministry_date < '$today' 
                AND ministry_start_date IS NOT NULL 
                AND ministry_end_date IS NULL 
                AND ministry_ing_cnt=0";
        $result = mysql_query($sql);
    }
}
?>