<?
include "../include/db_connect.php";  // 데이터베이스 연결 스크립트를 포함
include "../include/function.php";  // 공통 함수들을 포함

// 요청된 파라미터들을 변수에 저장
$req_map_sub_idx = $_REQUEST["map_sub_idx"];
$req_map_sub_info = $_REQUEST["map_sub_info"];
$req_map_sub_addr = $_REQUEST["map_sub_addr"];
$req_h = $_REQUEST["h"];

// map_sub_info가 비어 있는 경우 기본값을 설정
if ($req_map_sub_info == ""){
	$req_map_sub_info = "정보없음";
}

// map_sub_addr가 비어 있는 경우 기본 주소를 설정
if ($req_map_sub_addr == ""){
	$req_map_sub_addr = "경기도 안성시 공도읍 양기리 377";
}

// h가 비어 있는 경우 기본 높이를 설정
if ($req_h == ""){
	$req_h = "500";
}

// map_sub_idx를 이용해 map_normal_sub 테이블에서 해당 구역 정보를 조회하는 SQL 쿼리 작성
$sql = "SELECT * FROM map_normal_sub WHERE map_sub_idx='$req_map_sub_idx'";
$result_type = mysql_query($sql);  // SQL 쿼리를 실행하고 결과를 변수에 저장
$rs = mysql_fetch_array($result_type);  // 결과를 배열로 저장

// 조회된 구역 정보들을 변수에 저장
$map_sub_no = $rs['map_sub_no'];
$map_sub_info = $rs['map_sub_info'];
$map_sub_cnt = $rs['map_sub_cnt'];
$map_sub_addr = $rs['map_sub_addr'];
$map_sub_polygon = $rs['map_sub_polygon'];

$bbb = "";  // 다각형 경로를 저장할 변수 초기화

// 구역의 다각형 좌표가 있는 경우 처리
if ($map_sub_polygon != ""){
	$chars = explode("),(", $map_sub_polygon);  // 좌표 문자열을 분할

	for ($i = 0; $i < count($chars); $i++) {
		if ($i == 0){
			$sss .= "new daum.maps.LatLng" . $chars[$i] . "),";  // 첫 번째 좌표 처리
		} else {
			if ($i == count($chars) - 1){
				$sss .= "new daum.maps.LatLng(" . $chars[$i];  // 마지막 좌표 처리
			} else {
				$sss .= "new daum.maps.LatLng(" . $chars[$i] . "),";  // 중간 좌표 처리
			}
		}
	}

	$bbb = $sss;  // 완성된 다각형 경로 문자열을 $bbb에 저장
}
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>주소로 장소 표시하기</title>
    
<style type="text/css">
	body{
		margin:0;
		padding:0;
	}
</style>

</head>
<body>

<div id="map" style="width:100%;height:<?=$req_h ?>px;"></div>  <!-- 지도를 표시할 div, 높이는 요청된 h 값에 따라 설정 -->

<!-- Kakao 지도 API를 로드하고 다각형 라이브러리를 포함 -->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=<?=DAUM_MAP_API ?>&libraries=services"></script>
<script>
var mapContainer = document.getElementById('map'), // 지도를 표시할 div
    mapOption = {
        center: new daum.maps.LatLng(37.000922, 127.195686), // 지도의 초기 중심 좌표 설정
        level: 3 // 지도의 확대 레벨 설정
    };  

// 지도를 생성
var map = new daum.maps.Map(mapContainer, mapOption); 

// 주소-좌표 변환 객체를 생성
var geocoder = new daum.maps.services.Geocoder();

// 주소로 좌표를 검색
geocoder.addressSearch('<?=$req_map_sub_addr ?>', function(result, status) {

    // 정상적으로 검색이 완료됐으면 
    if (status === daum.maps.services.Status.OK) {

        var coords = new daum.maps.LatLng(result[0].y, result[0].x);  // 검색된 좌표를 변수에 저장

        // 결과값으로 받은 위치를 마커로 표시
        var marker = new daum.maps.Marker({
            map: map,
            position: coords
        });

        // 인포윈도우로 장소에 대한 설명을 표시
        var infowindow = new daum.maps.InfoWindow({
            content: '<div style="width:150px;text-align:center;padding:6px 0;"><?=$req_map_sub_info ?></div>'
        });
        infowindow.open(map, marker);  // 인포윈도우를 지도에 마커와 함께 표시

        // 지도의 중심을 결과값으로 받은 위치로 이동
        map.setCenter(coords);
    } 
});    


// 지도에 다각형을 표시
var polygon = new daum.maps.Polygon({
	map : map, // 다각형을 표시할 지도 객체
	path:[<?=$bbb ?>],  // 다각형 경로 설정
	fillColor: '#FF0000', // 채움 색 설정
	fillOpacity: 0.3, // 채움 불투명도 설정
	strokeWeight: 2, // 선의 두께 설정
	strokeColor: '#FF0000', // 선 색 설정
	strokeOpacity: 0.9, // 선 투명도 설정
	strokeStyle: 'solid' // 선 스타일 설정
});
</script>
</body>
</html>