<?
include "../include/db_connect.php"; // 데이터베이스 연결을 위한 파일 포함
include "../include/function.php"; // 공통 함수 파일 포함

session_check(); // 세션 확인

// 관리자 권한 확인 (1, 2, 3 등급만 접근 가능)
if (!mgr_check("1,2,3")){
	echo "<script>location.href='/home/';</script>"; // 권한이 없으면 홈으로 리다이렉트
}

$req_map_idx = $_REQUEST["map_idx"]; // 요청된 지도 인덱스
$req_map_service = $_REQUEST["map_service"]; // 요청된 서비스 유형
$req_map_review = $_REQUEST["map_review"]; // 요청된 리뷰 옵션

$ministry_date = date("Y-m-d"); // 오늘 날짜를 기본 값으로 설정

// 구역 지정 원칙
// 구역 지정이 안된 것은 여러 개를 동시 선택 가능, 단, 구역 지정이 된 것은 선택취소가 되도록 함 (신규생성)
// 구역 지정이 된 것은 여러 개를 동시 선택 가능, 단, 구역 지정이 안된 것은 선택취소가 되도록 함 (지정일자, 봉사형태를 수정)
// 종료일이 있는 것은 선택이 불가
// 구역취소는 지정일만 있는 것으로 한다.
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ko" xml:lang="ko">
<head>
<?include "../include/head.html"; // 헤더 파일 포함 ?>
<style type="text/css">
	/* 네비게이션 스타일 정의 */
	.nav-pills > li.active > a,
	.nav-pills > li.active > a:hover,
	.nav-pills > li.active > a:focus {
		color: #fff;
		background-color: #5bc0de;
	}

	.nav > li > a {
		position: relative;
		display: block;
		padding: 10px 15px;
		background-color: #eee;
	}

	.nav a{
		color:#5bc0de;
	}
</style>
</head>
<body> 

    <!-- 고정된 네비게이션 바 -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
          <a class="navbar-brand" href="/home/"><img src="/img/icon-home.png"></a> 
          <!-- 네비게이션 경로 표시 -->
          <div class="navpress">
			  <a href="/guide/">인도자</a> > <a href="/guide/guide_content.html?map_service=<?=$req_map_service ?>">봉사기록</a> > <a href="#"><strong>구역선택</strong></a>
		  </div>
      </div>
    </nav>

    <div class="page">
      <div class="container">

		  <!-- 봉사 구역 선택 탭 -->
		  <div class="row marginbottom10">
			<div class="col-sm-12">
			  <ul class="nav nav-pills">
				<li<?=($req_map_service=="normal")?" class=\"active\"":"" ?>><a href="guide_content.html?map_service=normal">일반</a></li>
				<li<?=($req_map_service=="apt")?" class=\"active\"":"" ?>><a href="guide_content.html?map_service=apt">아파트</a></li>
				<li<?=($req_map_service=="display")?" class=\"active\"":"" ?>><a href="guide_content.html?map_service=display">전시대</a></li>
				<li<?=($req_map_service=="letter")?" class=\"active\"":"" ?>><a href="guide_content.html?map_service=letter">편지봉사</a></li>
			  </ul>
			</div>
		  </div>

		  <!-- 구역 선택 리스트 -->
		  <div class="row col-sm-12 marginbottom10">
			  <ul class="nav nav-pills">
<?
$sql="SELECT * FROM map_normal WHERE map_service='$req_map_service' order by map_rank"; // 요청된 서비스에 해당하는 구역을 가져오는 쿼리
$result = mysql_query($sql);

while($rs = mysql_fetch_array($result)){

	$map_idx = $rs['map_idx']; // 구역 인덱스
	$map_no = $rs['map_no']; // 구역 번호
	?>
				<!-- 구역 번호 링크 -->
				<li<?=($map_idx == $req_map_idx)?" class=\"active\"":"" ?>><a href="?map_idx=<?=$map_idx ?>&map_service=<?=$req_map_service ?>"><?=$map_no ?></a></li>
	<?
}
?>
			  </ul>
		</div>

		<!-- 구역 상태에 따른 스타일과 정보 -->
		<div id="grid" class="row col-sm-12 marginbottom10">
<?
$sql3 = "
select *
	, (cnt+visit_cnt+empty_cnt) as tot_cnt
	, (select m_name from member where m_idx=T.ministry_member_idx) as map_sub_member_name  
from
(
	SELECT a.map_idx, a.map_sub_idx, a.map_sub_no, a.map_sub_info, a.map_sub_addr, a.map_sub_polygon

	, (select ministry_member_idx from ministry_list where map_sub_idx=a.map_sub_idx and ministry_date is null) as ministry_member_idx
	
	, (select ministry_date       from ministry_list where map_sub_idx=a.map_sub_idx order by ministry_idx desc limit 1) as ministry_date
	, (select ministry_start_date from ministry_list where map_sub_idx=a.map_sub_idx order by ministry_idx desc limit 1) as ministry_start_date
	, (select ministry_end_date   from ministry_list where map_sub_idx=a.map_sub_idx order by ministry_idx desc limit 1) as ministry_end_date
	, (select service_type from db_service_type where service_idx=(select ministry_service_idx from ministry_list where map_sub_idx=a.map_sub_idx order by ministry_idx desc limit 1)) as service_type

	, (select ministry_start_date from ministry_list_record where map_sub_idx=a.map_sub_idx order by idx desc limit 1) as last_ministry_start_date
	, (select ministry_end_date   from ministry_list_record where map_sub_idx=a.map_sub_idx order by idx desc limit 1) as last_ministry_end_date

	, case when isnull(cnt)       then 0 else cnt       end cnt
	, case when isnull(visit_cnt) then 0 else visit_cnt end visit_cnt
	, case when isnull(empty_cnt) then 0 else empty_cnt end empty_cnt
	, case when isnull(content_cnt) then 0 else content_cnt end content_cnt
			
	FROM map_normal_sub a 

			  left join (SELECT map_sub_idx, count(map_sub_idx) as cnt           FROM map_normal_list where map_list_visit_c='' and map_list_enter_c<>'N'  group by map_sub_idx ) as c on a.map_sub_idx=c.map_sub_idx
			  left join (SELECT map_sub_idx, count(map_sub_idx) as visit_cnt     FROM map_normal_list where map_list_visit_c='Y' group by map_sub_idx ) as d on a.map_sub_idx=d.map_sub_idx
			  left join (SELECT map_sub_idx, count(map_sub_idx) as empty_cnt     FROM map_normal_list where map_list_visit_c='N' group by map_sub_idx ) as e on a.map_sub_idx=e.map_sub_idx
			  left join (SELECT map_sub_idx, COUNT(map_sub_idx) AS content_cnt FROM (SELECT (SELECT map_sub_idx FROM map_normal_list WHERE map_list_idx=a.map_list_idx) AS map_sub_idx FROM map_normal_list_content a) f group BY map_sub_idx) as ff on a.map_sub_idx=ff.map_sub_idx

	WHERE a.map_idx='$req_map_idx'
) T
order by map_sub_no";

$result = mysql_query($sql3);

while($rs = mysql_fetch_array($result)){

	$map_sub_idx = $rs['map_sub_idx'];
	$map_sub_no = $rs['map_sub_no'];
	$map_sub_info = $rs['map_sub_info'];
	$ministry_member_idx = $rs['ministry_member_idx'];
	$map_sub_member_name = $rs['map_sub_member_name'];
	
	$ministry_date = $rs['ministry_date'];
	$ministry_start_date = $rs['ministry_start_date'];
	$ministry_end_date = $rs['ministry_end_date'];
	$service_type = $rs['service_type'];

	$last_ministry_start_date = $rs['last_ministry_start_date'];
	$last_ministry_end_date = $rs['last_ministry_end_date'];

	$ministry_tot_cnt = $rs['tot_cnt']; 
	$ministry_visit_cnt = $rs['visit_cnt']; // 방문 수
	$ministry_empty_cnt = $rs['empty_cnt']; // 부재 수
	$ministry_content_cnt = $rs['content_cnt']; // 봉사기록 수

	// 구역 상태 결정
	if ($ministry_date == "" && $ministry_start_date == "" && $ministry_end_date == ""){
		$map_dse = "N";
	} else if ($ministry_date != "" && $ministry_start_date == "" && $ministry_end_date == ""){
		$map_dse = "D";	
	} else if ($ministry_date != "" && $ministry_start_date != "" && $ministry_end_date == ""){
		$map_dse = "S";	
	} else if ($ministry_date != "" && $ministry_start_date != "" && $ministry_end_date != ""){
		$map_dse = "E";	
	}
	if ($ministry_member_idx > 0){
		$map_dse = "P";	
	}
	?>
		<span class="grid_list" aria-map-dse="<?=$map_dse ?>">
			  <input type="checkbox" class="check_map_dse_<?=$map_dse ?>" name="check_map_sub_idx" id="check_map_sub_idx_<?=$map_sub_idx ?>" value="<?=$map_sub_idx ?>" data-map-sub-no="<?=$map_sub_no ?>" data-map-dse="<?=$map_dse ?>" style="display:none;"><?//=$map_sub_idx ?>
			  <button type="button" id="map_sub_idx_<?=$map_sub_idx ?>" onclick="map_choice(<?=$map_sub_idx ?>, '<?=$map_dse ?>')" class="map_dse_<?=$map_dse ?> btn btn-default3 
			  
			  <?if ($ministry_member_idx > 0){?>
			  --btn-danger
			  <?}?>
			
			  <?if ($ministry_date == "" && $ministry_start_date == "" && $ministry_end_date == ""){?>
			  --btn-info
			  <?}else if ($ministry_date != "" && $ministry_start_date == "" && $ministry_end_date == ""){?>
			  --btn-primary
			  <?}else if ($ministry_date != "" && $ministry_start_date != "" && $ministry_end_date != ""){?>
			  --btn-complete
			  <?}else if ($ministry_date != "" && $ministry_start_date != ""){?>
			  --btn-success
			  <?}?>	  
			  btn-info
			  " 
			  
			  <?if ($ministry_member_idx > 0){?>
			  --disabled
			  <?}?>
			  
			  <?if ($ministry_date != "" && $ministry_start_date != "" && $ministry_end_date != ""){?>
			  --disabled
			  <?}?>
			  >
			  
			  <?=$map_sub_no ?><br>
			  
			  <?if ($ministry_member_idx > 0){?><span style="font-size:10px;">개인:<?=$map_sub_member_name ?></span><br><?}?>
			  
			  <?if ($service_type != ""){?><span style="font-size:11px;color:#ffffff">T:<?=$service_type ?></span><br><?}?>
			  <?if ($ministry_date != ""){?><span style="font-size:11px;color:#ffff00">D:<?=$ministry_date ?></span><br><?}?>
			  <?if ($ministry_start_date != ""){?><span style="font-size:11px;color:#ffffff">S:<?=$ministry_start_date ?></span><br><?}?>
			  <?if ($ministry_end_date != ""){?><span style="font-size:11px;color:#ffffff">E:<?=$ministry_end_date ?></span><?}?>

			  <div style="border-top:1px solid #ffffff;padding-top:5px;margin-top:5px;">
				  <span style="font-size:10px;">
					전체 <?=$ministry_tot_cnt ?> 방문 <?=$ministry_visit_cnt ?><br>
					부재 <?=$ministry_empty_cnt ?> 남은집 <?=$ministry_tot_cnt - $ministry_visit_cnt - $ministry_empty_cnt ?><br>
					봉사기록 <?=$ministry_content_cnt ?>
				  </span>
			  </div>

			  <?if ($last_ministry_start_date != "") {?>
			  <div style="border-top:1px solid #ffffff;margin-top:5px;">
			  <span style="font-size:10px;color: #ffffff">LS:<?=$last_ministry_start_date ?></span>
			  <?if ($last_ministry_end_date != ""){?>
			  <br>
			  <span style="font-size:10px;color: #ffffff">LE:<?=$last_ministry_end_date ?></span>
			  <?}?>
			  </div>
			  <?}?>
			  
			  </button>
		</span>
	<?
}
?>
		</div>

		<!-- 선택된 구역의 리스트 표시 -->
		<div class="row col-sm-12 marginbottom10">
			<div id="map_normal_list"></div>
		</div>

      </div>
    </div>

<?include "../include/footer.html"; // 푸터 포함 ?>

</body>
</html>
<script src="/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript">
<!--
	$( "#ministry_date" ).datepicker({
		// 달력의 설정 (한국어 날짜 형식)
		dateFormat: 'yy-mm-dd',
		prevText: '이전 달',
		nextText: '다음 달',
		monthNames: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'],
		monthNamesShort: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'],
		dayNames: ['일','월','화','수','목','금','토'],
		dayNamesShort: ['일','월','화','수','목','금','토'],
		dayNamesMin: ['일','월','화','수','목','금','토'],
		showMonthAfterYear: true,
		yearSuffix: '년',
	});	
//-->
</script>
<script type="text/javascript">
<!--

	var map_review = "<?=$req_map_review ?>";

	if (map_review == "true") {
		$("#map_review").prop("checked",true);
	}

	// 구역 상태에 따라 필터링하는 기능
	$("#btn-person, #btn-nothing, #btn-date, #btn-start, #btn-end").click(function (){
		
		var dse_val = $(this).attr("aria-dse-val");

		$(this).toggleClass("active");

		$(".grid_list").each(function (){
			
			var aria_map_dse = $(this).attr("aria-map-dse");

			if (aria_map_dse == dse_val) {
				if ($(this).css("display") == "none"){
					$(this).css("display","inline");
				} else {
					$(this).css("display","none");
				}
			}
		});		
	});

	function map_choice(map_sub_idx, map_dse){
		// 구역 선택 시 해당 구역의 세부 페이지로 이동
		location.href = "guide_content_map_list.html?map_sub_idx="+map_sub_idx+"&map_idx=<?=$req_map_idx ?>&map_service=<?=$req_map_service ?>";
		return;
	}

// 필요한 경우 추가적인 기능이 포함된 코드는 주석 처리하여 설명
//	function guide_choice(){ /* ... */ }
//	function guide_cancel(){ /* ... */ }
	function map_list(map_sub_idx){
		// 선택된 구역의 리스트를 불러오는 함수

		if (map_sub_idx == 0) {
			$("#map_normal_list").html("");
			return;
		}

		var map_service = "<?=$req_map_service ?>";

		if (map_service == "display") {
			return;
		}

		$.ajax({
			type: "post",
			url: "guide_choice_work.php",
			data: "work=map_normal_list&map_sub_idx="+map_sub_idx,
			success: function (msg) {
				$("#map_normal_list").html(msg);
			}
		});	

	}

	function map_list_enter_Y(map_sub_idx, map_list_idx){
		// 방문 거절 항목 체크 기능

		var enter_Y = $("#map_list_enter_Y_" + map_list_idx);
		var enter_N = $("#map_list_enter_N_" + map_list_idx);

		enter_N.prop("checked", false);

		var set_enter = "";

		if (enter_Y.prop("checked") == true){
			set_enter = "Y";
		} else {
			set_enter = "";
		}

		map_list_update(map_sub_idx, map_list_idx, "map_list_enter", set_enter);
	}

	function map_list_enter_N(map_sub_idx, map_list_idx){
		// 방문 금지 항목 체크 기능

		var enter_Y = $("#map_list_enter_Y_" + map_list_idx);
		var enter_N = $("#map_list_enter_N_" + map_list_idx);

		enter_Y.prop("checked", false);

		var set_enter = "";

		if (enter_N.prop("checked") == true){
			set_enter = "N";
		} else {
			set_enter = "";
		}

		map_list_update(map_sub_idx, map_list_idx, "map_list_enter", set_enter);
	}

	function map_list_update(map_sub_idx, map_list_idx, field, val){
		// 리스트 항목을 업데이트하는 함수

		$.ajax({
			type: "post",
			url: "guide_choice_work.php",
			data: "work=map_list_update&map_sub_idx="+map_sub_idx+"&map_list_idx="+map_list_idx+"&field="+field+"&val="+val,
			success: function (msg) {
			}
		});	

	}

	function map_save(map_list_idx) {
		// 구분선 저장 기능

		var map_list_line = $("#map_list_line_"+map_list_idx).prop("checked") == true ? "1" : "0";

		$.ajax({
			type: "post",
			url: "guide_choice_work.php",
			data: "work=map_save&map_list_idx=" + map_list_idx + "&map_list_line=" + map_list_line,
			success: function (msg) {
			}
		});
	}

//-->
</script>